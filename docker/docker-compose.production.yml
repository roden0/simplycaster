# Docker Compose Configuration for Production Environment
# SimplyCaster with COTURN ICE Server Integration

version: '3.8'

services:
  # SimplyCaster Application (Load Balanced)
  app:
    image: simplycast/app:${APP_VERSION:-latest}
    deploy:
      replicas: 3
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    environment:
      - NODE_ENV=production
      - ENVIRONMENT=production
    env_file:
      - ../config/environments/production.env
    secrets:
      - coturn_secret
      - turn_master_key
      - ssl_cert
      - ssl_key
    volumes:
      - app_logs:/app/logs
      - app_uploads:/app/uploads
    depends_on:
      - postgres
      - redis
      - coturn
    networks:
      - simplycast-prod
      - coturn-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Load Balancer
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      - app
    networks:
      - simplycast-prod
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

  # PostgreSQL Database (Primary)
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: simplycast_prod
      POSTGRES_USER: simplycast
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
    secrets:
      - postgres_password
    volumes:
      - postgres_prod_data:/var/lib/postgresql/data
      - postgres_backups:/backups
    networks:
      - simplycast-prod
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U simplycast -d simplycast_prod"]
      interval: 30s
      timeout: 10s
      retries: 3

  # PostgreSQL Database (Replica for Read Operations)
  postgres-replica:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: simplycast_prod
      POSTGRES_USER: simplycast
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      PGUSER: simplycast
    secrets:
      - postgres_password
    volumes:
      - postgres_replica_data:/var/lib/postgresql/data
    networks:
      - simplycast-prod
    restart: unless-stopped
    command: >
      postgres
      -c wal_level=replica
      -c max_wal_senders=3
      -c max_replication_slots=3
      -c hot_standby=on

  # Redis Cluster
  redis-master:
    image: redis:7-alpine
    volumes:
      - redis_master_data:/data
      - ./redis/redis.conf:/etc/redis/redis.conf:ro
    networks:
      - simplycast-prod
    restart: unless-stopped
    command: redis-server /etc/redis/redis.conf
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  redis-replica:
    image: redis:7-alpine
    volumes:
      - redis_replica_data:/data
    networks:
      - simplycast-prod
    restart: unless-stopped
    command: redis-server --replicaof redis-master 6379
    depends_on:
      - redis-master

  # COTURN ICE Server (High Availability)
  coturn:
    image: coturn/coturn:latest
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        delay: 30s
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
    ports:
      - "3478:3478/udp"
      - "3478:3478/tcp"
      - "5349:5349/tcp"  # TURNS
      - "443:443/tcp"    # TCP fallback
      - "49152-65535:49152-65535/udp"
    environment:
      - COTURN_HOST=turn.simplycast.com
      - COTURN_PORT=3478
      - COTURN_TURNS_PORT=5349
      - COTURN_REALM=simplycast.com
      - COTURN_USE_SSL=true
      - COTURN_MIN_PORT=49152
      - COTURN_MAX_PORT=65535
      - COTURN_LOG_LEVEL=2
    secrets:
      - coturn_secret
      - ssl_cert
      - ssl_key
    volumes:
      - ./coturn/turnserver.production.conf:/etc/coturn/turnserver.conf:ro
      - coturn_prod_logs:/var/log/coturn
      - coturn_ssl:/etc/ssl/coturn:ro
    networks:
      - coturn-network
      - simplycast-prod
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "turnutils_stunclient", "-H", "localhost", "-P", "3478"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 60s
    command: >
      turnserver
      -c /etc/coturn/turnserver.conf
      --log-file=/var/log/coturn/turnserver.log
      --pidfile=/var/run/turnserver.pid
      --cert=/etc/ssl/coturn/cert.pem
      --pkey=/etc/ssl/coturn/key.pem

  # Monitoring Stack
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    networks:
      - simplycast-prod
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD_FILE=/run/secrets/grafana_password
    secrets:
      - grafana_password
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    networks:
      - simplycast-prod
    restart: unless-stopped

  # Log Aggregation
  loki:
    image: grafana/loki:latest
    ports:
      - "3100:3100"
    volumes:
      - ./monitoring/loki.yml:/etc/loki/local-config.yaml:ro
      - loki_data:/loki
    networks:
      - simplycast-prod
    restart: unless-stopped

  promtail:
    image: grafana/promtail:latest
    volumes:
      - ./monitoring/promtail.yml:/etc/promtail/config.yml:ro
      - app_logs:/var/log/app:ro
      - nginx_logs:/var/log/nginx:ro
      - coturn_prod_logs:/var/log/coturn:ro
    networks:
      - simplycast-prod
    restart: unless-stopped

  # Backup Service
  backup:
    image: postgres:16-alpine
    environment:
      PGPASSWORD_FILE: /run/secrets/postgres_password
    secrets:
      - postgres_password
    volumes:
      - postgres_backups:/backups
      - ./scripts/backup.sh:/backup.sh:ro
    networks:
      - simplycast-prod
    restart: "no"
    command: /backup.sh
    depends_on:
      - postgres

volumes:
  postgres_prod_data:
    driver: local
  postgres_replica_data:
    driver: local
  postgres_backups:
    driver: local
  redis_master_data:
    driver: local
  redis_replica_data:
    driver: local
  coturn_prod_logs:
    driver: local
  coturn_ssl:
    driver: local
  app_logs:
    driver: local
  app_uploads:
    driver: local
  nginx_logs:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
  loki_data:
    driver: local

networks:
  simplycast-prod:
    driver: overlay
    attachable: true
    ipam:
      config:
        - subnet: 10.0.1.0/24
  coturn-network:
    driver: overlay
    attachable: true
    ipam:
      config:
        - subnet: 10.0.2.0/24

secrets:
  coturn_secret:
    external: true
  turn_master_key:
    external: true
  postgres_password:
    external: true
  grafana_password:
    external: true
  ssl_cert:
    external: true
  ssl_key:
    external: true